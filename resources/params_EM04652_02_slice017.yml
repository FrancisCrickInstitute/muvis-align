general:
  show_original: False
  metadata_summary: False
  chunk_size: [10240, 10240]
  break_on_error: True
  logging:
    filename: log/muvis-align-EM04652.log
    format: '%(asctime)s %(levelname)s: %(message)s'
    dask: True
    time: True
    verbose: True
  output:
    clear: False
    overwrite: False
    format: ome.zarr
    ome_version: 0.5
    tile_size: [10240, 10240]
    compression:
    npyramid_add: 4
    pyramid_downsample: 2
    thumbnail: ome.tiff
    thumbnail_scale: 1um

operations:
  - operation: register match s
    #input: /nemo/project/proj-mrc-mm/raw/em/EM04652/EM04652_02_slice017/EM04652-02_slice17_spaghettiandmeatballs2/**/*.ome.tif
    input: /nemo/project/proj-mrc-mm/raw/em/EM04652/EM04652_02_slice017/EM04652-02_slice17_spaghettiandmeatballs2/**/*_s00400.ome.tif
    #input: D:/slides/EM04652-02_slice17_spaghettiandmeatballs2/**/*_s00500.ome.tif
    #input: D:/slides/EM04652-02_slice17_spaghettiandmeatballs2/**/*_s00012.ome.tif
    #input: D:/slides/EM04652-02_slice17_spaghettiandmeatballs2/tiles_slice394/*.ome.tif
    source_metadata: sbem
    normalisation: global
    gaussian_sigma: 1.5
    #pairing: overlay
    transform_type: translation
    method: phase_correlation
    #method:
    #  name: sift
    #  max_keypoints: 5000
    #  inlier_threshold_factor: 0.05
    #  max_trials: 1000
    #  ransac_iterations: 3
    #fusion: compose
    n_set_workers: 64
    n_parallel_pairwise_regs: 64
    output: ../../stitched/s{s}/

  - operation: register stack
    input: /nemo/project/proj-mrc-mm/raw/em/EM04652/EM04652_02_slice017/EM04652-02_slice17_spaghettiandmeatballs2/overviews/ov000/*.ome.tif
    #input: D:/slides/EM04652-02_slice17_spaghettiandmeatballs2/overviews/ov000/*.ome.tif
    #input:
    #  - D:/slides/EM04652-02_slice17_spaghettiandmeatballs2/overviews/ov000/EM04652-02_slice17_spaghettiandmeatballs2_ov000_s00000.ome.tif
    #  - D:/slides/EM04652-02_slice17_spaghettiandmeatballs2/overviews/ov000/EM04652-02_slice17_spaghettiandmeatballs2_ov000_s00001.ome.tif
    source_metadata: {'position': {'y': 0, 'x': 0}, rotation: null}
    normalisation: global
    gaussian_sigma: 2.5
    transform_type: affine
    #method: phase_correlation
    method:
      name: orb
      #gaussian_sigma: 2.5
      max_keypoints: 5000
      inlier_threshold_factor: 0.05
      max_trials: 1000
      ransac_iterations: 3
    output_spacing: mean
    n_parallel_pairwise_regs: 64
    output: ../../aligned/ov_

  - operation: stack
    input: /nemo/project/proj-mrc-mm/raw/em/EM04652/EM04652_02_slice017/EM04652-02_slice17_spaghettiandmeatballs2/stitched/s*/registered.ome.zarr
    #input:
    #  - D:/slides/EM04652-02_slice17_spaghettiandmeatballs2/stitched/s00000/registered.ome.zarr
    #  - D:/slides/EM04652-02_slice17_spaghettiandmeatballs2/stitched/s00001/registered.ome.zarr
    #source_metadata: /nemo/project/proj-mrc-mm/raw/em/EM04652/EM04652_02_slice017/EM04652-02_slice17_spaghettiandmeatballs2/aligned/ov_mappings.json
    mappings: ov_mappings.json
    output_spacing: mean
    n_parallel_pairwise_regs: 64
    output: ../../aligned/
